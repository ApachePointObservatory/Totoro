#!/usr/bin/env python
# encoding: utf-8
"""
conversion.py

Created by José Sánchez-Gallego on 13 Dec 2013.
Copyright (c) 2013. All rights reserved.
Licensed under a 3-clause BSD license.

This file includes classes and function to convert
between different types of data.

"""

__ALL__ = ['utc2lmst', 'lmst2utc']

from astropy.coordinates.angles import Longitude
from ..exceptions import TotoroError
from astropy.units import degree, hour, hourangle
from astropy.coordinates import Angle
from astropy import time
from ..core.defaults import LONGITUDE


def utc2lmst(utc, format='jd', longitude=LONGITUDE()):
    """Returns the LMST for a UTC time.

    This function returns the LMST for a certain UTC time
    assuming that delta_ut1_utc=0.0.

    Parameters
    ----------
    utc : `astropy.time.Time` object or float
        The UTC time.
    format : str, optional
        If utc is a float, this format will be used to create a `Time` object.
    longitude : float or `Longitude` object, optional
        The longitude of the site at which the LMST
        is calculated. If not define, APO longitude will
        be used. East longitudes with longitude in the range
        [0, 360) degrees should be used.

    Returns
    -------
    lmst : `astropy.coordinates.angle.Longitude` object
        The LMST for the input UTC at the specified longitude.

    """

    if isinstance(longitude, Longitude):
        pass
    else:
        try:
            longitude = Longitude(longitude, unit=degree)
        except:
            raise TotoroError('longitude cannot be understood.')

    if not isinstance(utc, time.Time):
        utc = time.Time(utc, format=format, scale='utc')

    utc.delta_ut1_utc = 0.0
    utc.lon = longitude

    return utc.sidereal_time('mean')


def lmst2utc(lmst, mjd, longitude=LONGITUDE()):
    """Inverse function for utc2lmst().

    Parameters
    ----------
    lmst : `astropy.coordinates.angle.Longitude` object or float
        The LMST in astropy Longitude format or as a float in hours.
    longitude : float or `astropy.coordinates.angles.Longitude` object
        The longitude of the site at which the LMST
        is calculated. If not define, APO longitude will
        be used. East longitudes with longitude in the range
        [0, 360) degrees should be used.

    Returns
    -------
    utc : `astropy.time.Time` object
        A time object with the time corresponding to the pair mjd and lmst.

    """

    if not isinstance(lmst, Longitude):
        lmst = Angle(lmst, unit=hourangle)

    if isinstance(longitude, Longitude):
        pass
    else:
        try:
            longitude = Longitude(longitude, unit=degree)
        except:
            raise TotoroError('longitude cannot be understood.')

    # Rewraps longitude to the range -180 to 180
    longitude.wrap_angle = 180 * degree

    if isinstance(mjd, time.Time):
        pass
    else:
        mjd = time.Time(mjd, format='mjd', scale='utc')

    # Calculates the sidereal time at the previous midnight
    midNight = time.Time(mjd.jd1, format='jd', scale='utc')
    midNightSidTime = utc2lmst(midNight, longitude=longitude)

    # Calculates UTC
    utc = lmst - midNightSidTime

    if utc.hour > 24.:
        utc -= Angle(24, unit=hour)
    elif utc.hour < 0.:
        utc += Angle(24, unit=hour)

    # Corrects for the difference between sidereal and UTC seconds
    utc = utc * 365.25 / 366.25

    # Converts UTC to a TimeDelta
    utc = time.TimeDelta(utc.hour * 3600, format='sec')

    # Creates a Time object from the MJD and UTC
    utcDate = midNight + utc

    return utcDate
